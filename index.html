<?php
// =============================================================================
// OMRIX - Professional Trading Analysis Platform
// Single File: index.php
// =============================================================================

// -----------------------------------------------------------------------------
// CONFIGURATION & CONSTANTS
// -----------------------------------------------------------------------------

define('DB_HOST', 'localhost');
define('DB_NAME', 'omrix_db');
define('DB_USER', 'omrix_user');
define('DB_PASS', 'secure_password_here'); // Change in production
define('AES_KEY', hash('sha256', 'your-32-char-encryption-key-here!!', true)); // Change in production

// -----------------------------------------------------------------------------
// DATABASE INITIALIZATION (Auto-create tables if not exist)
// -----------------------------------------------------------------------------

function initDatabase() {
    try {
        $pdo = new PDO("mysql:host=" . DB_HOST, DB_USER, DB_PASS);
        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        
        // Create database if not exists
        $pdo->exec("CREATE DATABASE IF NOT EXISTS " . DB_NAME . " CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci");
        $pdo->exec("USE " . DB_NAME);
        
        // Users table
        $pdo->exec("CREATE TABLE IF NOT EXISTS users (
            id INT AUTO_INCREMENT PRIMARY KEY,
            email VARCHAR(255) UNIQUE NOT NULL,
            password_hash VARCHAR(255) NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            last_login TIMESTAMP NULL
        )");
        
        // Deriv accounts table with encrypted tokens
        $pdo->exec("CREATE TABLE IF NOT EXISTS deriv_accounts (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            encrypted_api_token TEXT NOT NULL,
            account_type ENUM('demo', 'real') DEFAULT 'demo',
            is_active BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
        )");
        
        // Analysis logs table
        $pdo->exec("CREATE TABLE IF NOT EXISTS analysis_logs (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            market VARCHAR(50) NOT NULL,
            analysis_type VARCHAR(50) NOT NULL,
            result_data JSON,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
        )");
        
        return $pdo;
    } catch (PDOException $e) {
        die("Database initialization failed: " . htmlspecialchars($e->getMessage()));
    }
}

// -----------------------------------------------------------------------------
// ENCRYPTION FUNCTIONS (AES-256)
// -----------------------------------------------------------------------------

function encryptToken($token) {
    $iv = random_bytes(16);
    $encrypted = openssl_encrypt($token, 'AES-256-CBC', AES_KEY, 0, $iv);
    return base64_encode($iv . $encrypted);
}

function decryptToken($encryptedToken) {
    $data = base64_decode($encryptedToken);
    $iv = substr($data, 0, 16);
    $encrypted = substr($data, 16);
    return openssl_decrypt($encrypted, 'AES-256-CBC', AES_KEY, 0, $iv);
}

// -----------------------------------------------------------------------------
// SESSION & CSRF MANAGEMENT
// -----------------------------------------------------------------------------

session_start();

function generateCSRFToken() {
    if (empty($_SESSION['csrf_token'])) {
        $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
    }
    return $_SESSION['csrf_token'];
}

function validateCSRFToken($token) {
    return isset($_SESSION['csrf_token']) && hash_equals($_SESSION['csrf_token'], $token);
}

function isLoggedIn() {
    return isset($_SESSION['user_id']) && !empty($_SESSION['user_id']);
}

function requireAuth() {
    if (!isLoggedIn()) {
        header("Location: ?page=login");
        exit();
    }
}

function logout() {
    session_destroy();
    header("Location: ?page=login");
    exit();
}

// -----------------------------------------------------------------------------
// REQUEST HANDLING
// -----------------------------------------------------------------------------

$pdo = initDatabase();
$page = isset($_GET['page']) ? $_GET['page'] : (isLoggedIn() ? 'dashboard' : 'login');

// Handle Logout
if (isset($_GET['action']) && $_GET['action'] === 'logout') {
    logout();
}

// Handle Login
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action']) && $_POST['action'] === 'login') {
    if (!validateCSRFToken($_POST['csrf_token'] ?? '')) {
        $loginError = "Invalid security token";
    } else {
        $email = filter_var(trim($_POST['email']), FILTER_SANITIZE_EMAIL);
        $password = $_POST['password'];
        
        $stmt = $pdo->prepare("SELECT id, password_hash FROM users WHERE email = ?");
        $stmt->execute([$email]);
        $user = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if ($user && password_verify($password, $user['password_hash'])) {
            $_SESSION['user_id'] = $user['id'];
            $_SESSION['user_email'] = $email;
            
            // Update last login
            $stmt = $pdo->prepare("UPDATE users SET last_login = NOW() WHERE id = ?");
            $stmt->execute([$user['id']]);
            
            header("Location: ?page=dashboard");
            exit();
        } else {
            $loginError = "Invalid credentials";
        }
    }
}

// Handle Registration
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action']) && $_POST['action'] === 'register') {
    if (!validateCSRFToken($_POST['csrf_token'] ?? '')) {
        $registerError = "Invalid security token";
    } else {
        $email = filter_var(trim($_POST['email']), FILTER_SANITIZE_EMAIL);
        $password = $_POST['password'];
        $confirmPassword = $_POST['confirm_password'];
        
        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            $registerError = "Invalid email format";
        } elseif (strlen($password) < 8) {
            $registerError = "Password must be at least 8 characters";
        } elseif ($password !== $confirmPassword) {
            $registerError = "Passwords do not match";
        } else {
            $stmt = $pdo->prepare("SELECT id FROM users WHERE email = ?");
            $stmt->execute([$email]);
            if ($stmt->fetch()) {
                $registerError = "Email already registered";
            } else {
                $hash = password_hash($password, PASSWORD_BCRYPT);
                $stmt = $pdo->prepare("INSERT INTO users (email, password_hash) VALUES (?, ?)");
                if ($stmt->execute([$email, $hash])) {
                    $registerSuccess = "Account created successfully. Please login.";
                } else {
                    $registerError = "Registration failed";
                }
            }
        }
    }
}

// Handle Deriv Account Connection
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action']) && $_POST['action'] === 'connect_deriv') {
    requireAuth();
    if (!validateCSRFToken($_POST['csrf_token'] ?? '')) {
        $derivError = "Invalid security token";
    } else {
        $token = trim($_POST['api_token']);
        $accountType = $_POST['account_type'] === 'real' ? 'real' : 'demo';
        
        if (strlen($token) < 10) {
            $derivError = "Invalid API token";
        } else {
            $encryptedToken = encryptToken($token);
            $stmt = $pdo->prepare("INSERT INTO deriv_accounts (user_id, encrypted_api_token, account_type) 
                                  VALUES (?, ?, ?) 
                                  ON DUPLICATE KEY UPDATE 
                                  encrypted_api_token = VALUES(encrypted_api_token),
                                  account_type = VALUES(account_type),
                                  is_active = TRUE");
            if ($stmt->execute([$_SESSION['user_id'], $encryptedToken, $accountType])) {
                $derivSuccess = "Deriv account connected successfully";
            } else {
                $derivError = "Failed to save account";
            }
        }
    }
}

// Handle Analysis Request
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action']) && $_POST['action'] === 'analyze') {
    requireAuth();
    header('Content-Type: application/json');
    
    $market = htmlspecialchars(trim($_POST['market'] ?? 'R_100'));
    $timeframe = htmlspecialchars(trim($_POST['timeframe'] ?? '1m'));
    
    // Simulated analysis (in production, this would connect to Deriv API)
    $analysis = [
        'market' => $market,
        'trend' => ['bullish', 'bearish', 'neutral'][random_int(0, 2)],
        'volatility' => round(mt_rand(10, 80) / 100, 2),
        'confidence' => round(mt_rand(40, 95) / 100, 2),
        'timestamp' => date('Y-m-d H:i:s'),
        'signals' => [
            'rsi' => mt_rand(20, 80),
            'macd' => ['bullish', 'bearish', 'neutral'][random_int(0, 2)],
            'bb_position' => round(mt_rand(0, 100) / 100, 2)
        ]
    ];
    
    // Log analysis
    $stmt = $pdo->prepare("INSERT INTO analysis_logs (user_id, market, analysis_type, result_data) VALUES (?, ?, ?, ?)");
    $stmt->execute([$_SESSION['user_id'], $market, 'technical', json_encode($analysis)]);
    
    echo json_encode($analysis);
    exit();
}

// Get User's Deriv Accounts
$derivAccounts = [];
if (isLoggedIn()) {
    $stmt = $pdo->prepare("SELECT id, account_type, is_active, created_at FROM deriv_accounts WHERE user_id = ? AND is_active = TRUE");
    $stmt->execute([$_SESSION['user_id']]);
    $derivAccounts = $stmt->fetchAll(PDO::FETCH_ASSOC);
}

// -----------------------------------------------------------------------------
// HTML OUTPUT
// -----------------------------------------------------------------------------
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="OMRIX - Professional Trading Analysis Platform">
    <title>OMRIX | Professional Trading Analysis</title>
    <style>
        :root {
            --primary: #00d4ff;
            --secondary: #7000ff;
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-input: #1a1a25;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --danger: #ff4757;
            --success: #00d26a;
            --warning: #ffa502;
            --border: #2a2a3a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 50%, rgba(112, 0, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%);
            animation: pulse 15s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* Navigation */
        .navbar {
            background: rgba(18, 18, 26, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.3s;
            font-weight: 500;
        }
        
        .nav-links a:hover {
            color: var(--primary);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
        }
        
        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }
        
        .alert-error {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        
        .alert-success {
            background: rgba(0, 210, 106, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        /* Metrics */
        .metric-card {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.05), rgba(112, 0, 255, 0.05));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.5rem;
        }
        
        /* Status Indicators */
        .status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-online {
            background: rgba(0, 210, 106, 0.1);
            color: var(--success);
        }
        
        .status-offline {
            background: rgba(255, 71, 87, 0.1);
            color: var(--danger);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: blink 2s infinite;
        }
        
        .status-online .status-dot {
            background: var(--success);
        }
        
        .status-offline .status-dot {
            background: var(--danger);
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Analysis Section */
        .analysis-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .select-input {
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            min-width: 150px;
        }
        
        .analysis-result {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 2rem;
            display: none;
        }
        
        .analysis-result.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .signal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .signal-item {
            background: var(--bg-card);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        
        .signal-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .signal-value {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        /* Disclaimer */
        .disclaimer {
            background: rgba(255, 165, 2, 0.1);
            border: 1px solid var(--warning);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .disclaimer strong {
            color: var(--warning);
            display: block;
            margin-bottom: 0.5rem;
        }
        
        /* Login/Register Container */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .auth-box {
            width: 100%;
            max-width: 450px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .auth-header .logo {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .auth-header p {
            color: var(--text-secondary);
        }
        
        .auth-footer {
            text-align: center;
            margin-top: 2rem;
            color: var(--text-secondary);
        }
        
        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
            }
            
            .nav-links {
                gap: 1rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .analysis-controls {
                flex-direction: column;
            }
            
            .auth-box {
                padding: 2rem;
            }
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--bg-input);
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle.active {
            background: var(--success);
        }
        
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle.active .toggle-slider {
            transform: translateX(30px);
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <?php if ($page === 'login' || $page === 'register'): ?>
    
    <!-- AUTHENTICATION PAGES -->
    <div class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <div class="logo">OMRIX</div>
                <p>Professional Trading Analysis Platform</p>
            </div>
            
            <?php if ($page === 'login'): ?>
                <?php if (isset($loginError)): ?>
                    <div class="alert alert-error"><?php echo htmlspecialchars($loginError); ?></div>
                <?php endif; ?>
                <?php if (isset($registerSuccess)): ?>
                    <div class="alert alert-success"><?php echo htmlspecialchars($registerSuccess); ?></div>
                <?php endif; ?>
                
                <form method="POST" action="?page=login">
                    <input type="hidden" name="csrf_token" value="<?php echo generateCSRFToken(); ?>">
                    <input type="hidden" name="action" value="login">
                    
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" name="email" class="form-input" required placeholder="Enter your email">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" name="password" class="form-input" required placeholder="Enter your password">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem;">Sign In</button>
                </form>
                
                <div class="auth-footer">
                    Don't have an account? <a href="?page=register">Create Account</a>
                </div>
                
            <?php else: ?>
                <?php if (isset($registerError)): ?>
                    <div class="alert alert-error"><?php echo htmlspecialchars($registerError); ?></div>
                <?php endif; ?>
                
                <form method="POST" action="?page=register">
                    <input type="hidden" name="csrf_token" value="<?php echo generateCSRFToken(); ?>">
                    <input type="hidden" name="action" value="register">
                    
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" name="email" class="form-input" required placeholder="Enter your email">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" name="password" class="form-input" required placeholder="Min 8 characters">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" name="confirm_password" class="form-input" required placeholder="Confirm password">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem;">Create Account</button>
                </form>
                
                <div class="auth-footer">
                    Already have an account? <a href="?page=login">Sign In</a>
                </div>
            <?php endif; ?>
            
            <div class="disclaimer" style="margin-top: 2rem; font-size: 0.8rem;">
                <strong>Risk Warning</strong>
                Trading involves significant risk of loss. OMRIX provides analysis tools only and does not guarantee profits or provide financial advice.
            </div>
        </div>
    </div>
    
    <?php else: ?>
    
    <!-- DASHBOARD PAGE -->
    <?php requireAuth(); ?>
    
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">OMRIX</div>
            <div class="nav-links">
                <a href="?page=dashboard">Dashboard</a>
                <a href="?page=analysis">Analysis</a>
                <a href="?page=settings">Settings</a>
                <span style="color: var(--text-secondary);">|</span>
                <span style="color: var(--primary);"><?php echo htmlspecialchars($_SESSION['user_email']); ?></span>
                <a href="?action=logout" class="btn btn-danger" style="padding: 0.5rem 1rem;">Logout</a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        
        <?php if ($page === 'dashboard'): ?>
        
        <!-- DASHBOARD OVERVIEW -->
        <div class="grid">
            <div class="metric-card">
                <div class="metric-value" id="marketTrend">--</div>
                <div class="metric-label">Market Trend</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="volatilityStatus">--</div>
                <div class="metric-label">Volatility</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="signalConfidence">--%</div>
                <div class="metric-label">Signal Confidence</div>
            </div>
            <div class="metric-card">
                <div class="metric-value"><?php echo count($derivAccounts); ?></div>
                <div class="metric-label">Connected Accounts</div>
            </div>
        </div>
        
        <!-- CONNECTION STATUS -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Deriv Connection Status</h2>
                <span class="status status-online">
                    <span class="status-dot"></span>
                    System Online
                </span>
            </div>
            
            <?php if (empty($derivAccounts)): ?>
                <div style="text-align: center; padding: 3rem;">
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">No Deriv accounts connected</p>
                    <a href="?page=settings" class="btn btn-primary">Connect Account</a>
                </div>
            <?php else: ?>
                <div style="display: grid; gap: 1rem;">
                    <?php foreach ($derivAccounts as $account): ?>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-input); border-radius: 8px;">
                            <div>
                                <strong><?php echo strtoupper($account['account_type']); ?> Account</strong>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    Connected: <?php echo date('M d, Y', strtotime($account['created_at'])); ?>
                                </div>
                            </div>
                            <span class="status status-online">
                                <span class="status-dot"></span>
                                Active
                            </span>
                        </div>
                    <?php endforeach; ?>
                </div>
            <?php endif; ?>
        </div>
        
        <!-- QUICK ANALYSIS -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Quick Market Analysis</h2>
            </div>
            
            <div class="analysis-controls">
                <select id="marketSelect" class="select-input">
                    <option value="R_100">Volatility 100 Index</option>
                    <option value="R_75">Volatility 75 Index</option>
                    <option value="R_50">Volatility 50 Index</option>
                    <option value="R_25">Volatility 25 Index</option>
                    <option value="R_10">Volatility 10 Index</option>
                </select>
                
                <select id="timeframeSelect" class="select-input">
                    <option value="1m">1 Minute</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m">15 Minutes</option>
                    <option value="1h">1 Hour</option>
                </select>
                
                <button onclick="runAnalysis()" class="btn btn-primary" id="analyzeBtn">
                    Run Analysis
                </button>
            </div>
            
            <div id="analysisResult" class="analysis-result">
                <h3 style="margin-bottom: 1rem; color: var(--primary);">Analysis Results</h3>
                <div class="signal-grid" id="signalGrid">
                    <!-- Populated by JavaScript -->
                </div>
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        <strong>Analysis Time:</strong> <span id="analysisTime"></span>
                    </p>
                </div>
            </div>
        </div>
        
        <?php elseif ($page === 'analysis'): ?>
        
        <!-- FULL ANALYSIS PAGE -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Advanced Market Analysis</h2>
            </div>
            
            <div class="analysis-controls">
                <select id="advMarketSelect" class="select-input">
                    <option value="R_100">Volatility 100 Index</option>
                    <option value="R_75">Volatility 75 Index</option>
                    <option value="R_50">Volatility 50 Index</option>
                    <option value="R_25">Volatility 25 Index</option>
                    <option value="R_10">Volatility 10 Index</option>
                    <option value="1HZ100V">HF Volatility 100</option>
                    <option value="1HZ75V">HF Volatility 75</option>
                    <option value="1HZ50V">HF Volatility 50</option>
                </select>
                
                <select id="advTimeframeSelect" class="select-input">
                    <option value="ticks">Ticks</option>
                    <option value="1m">1 Minute</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m">15 Minutes</option>
                    <option value="1h">1 Hour</option>
                    <option value="4h">4 Hours</option>
                </select>
                
                <button onclick="runAdvancedAnalysis()" class="btn btn-primary" id="advAnalyzeBtn">
                    Generate Report
                </button>
            </div>
            
            <div id="advAnalysisResult" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="metric-card">
                        <div class="metric-value" id="advTrend">--</div>
                        <div class="metric-label">Trend Direction</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="advStrength">--%</div>
                        <div class="metric-label">Trend Strength</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="advVolatility">--</div>
                        <div class="metric-label">Volatility Level</div>
                    </div>
                </div>
                
                <div style="background: var(--bg-input); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--primary);">Technical Indicators</h4>
                    <div class="signal-grid" id="advSignalGrid"></div>
                </div>
                
                <div style="background: var(--bg-input); padding: 1.5rem; border-radius: 12px;">
                    <h4 style="margin-bottom: 1rem; color: var(--primary);">Market Summary</h4>
                    <p id="marketSummary" style="color: var(--text-secondary); line-height: 1.8;"></p>
                </div>
            </div>
        </div>
        
        <?php elseif ($page === 'settings'): ?>
        
        <!-- SETTINGS PAGE -->
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Connect Deriv Account</h2>
                </div>
                
                <?php if (isset($derivError)): ?>
                    <div class="alert alert-error"><?php echo htmlspecialchars($derivError); ?></div>
                <?php endif; ?>
                <?php if (isset($derivSuccess)): ?>
                    <div class="alert alert-success"><?php echo htmlspecialchars($derivSuccess); ?></div>
                <?php endif; ?>
                
                <form method="POST" action="?page=settings">
                    <input type="hidden" name="csrf_token" value="<?php echo generateCSRFToken(); ?>">
                    <input type="hidden" name="action" value="connect_deriv">
                    
                    <div class="form-group">
                        <label class="form-label">API Token</label>
                        <input type="text" name="api_token" class="form-input" required placeholder="Enter your Deriv API token">
                        <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                            Your token is encrypted using AES-256 before storage
                        </small>
                    </div>
                    
                    <div class="toggle-container">
                        <div class="toggle" id="accountToggle" onclick="this.classList.toggle('active')">
                            <div class="toggle-slider"></div>
                        </div>
                        <span id="accountTypeLabel">Demo Account</span>
                        <input type="hidden" name="account_type" id="accountTypeInput" value="demo">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Connect Securely</button>
                </form>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-dark); border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary);">
                    <strong style="color: var(--warning);">Security Note:</strong>
                    Never share your API token. OMRIX encrypts all tokens and never stores them in plain text.
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Connected Accounts</h2>
                </div>
                
                <?php if (empty($derivAccounts)): ?>
                    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                        No accounts connected
                    </p>
                <?php else: ?>
                    <?php foreach ($derivAccounts as $account): ?>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-input); border-radius: 8px; margin-bottom: 1rem;">
                            <div>
                                <strong style="color: <?php echo $account['account_type'] === 'real' ? 'var(--danger)' : 'var(--success)'; ?>">
                                    <?php echo strtoupper($account['account_type']); ?>
                                </strong>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    ID: <?php echo $account['id']; ?>
                                </div>
                            </div>
                            <span class="status status-online">
                                <span class="status-dot"></span>
                                Active
                            </span>
                        </div>
                    <?php endforeach; ?>
                <?php endif; ?>
            </div>
        </div>
        
        <?php endif; ?>
        
        <!-- DISCLAIMER -->
        <div class="disclaimer">
            <strong>⚠️ Risk Disclaimer</strong>
            OMRIX provides market analysis tools only. Trading involves substantial risk of loss and is not suitable for all investors. 
            Past performance is not indicative of future results. OMRIX does not provide financial advice, investment recommendations, 
            or guarantee any trading profits. All analysis should be used for informational purposes only. Always conduct your own 
            research and consider seeking advice from an independent financial advisor before making any investment decisions.
        </div>
        
    </div>
    
    <script>
        // Account Type Toggle
        document.getElementById('accountToggle')?.addEventListener('click', function() {
            const isActive = this.classList.contains('active');
            document.getElementById('accountTypeLabel').textContent = isActive ? 'Real Account' : 'Demo Account';
            document.getElementById('accountTypeInput').value = isActive ? 'real' : 'demo';
        });
        
        // Analysis Functions
        async function runAnalysis() {
            const btn = document.getElementById('analyzeBtn');
            const result = document.getElementById('analysisResult');
            const grid = document.getElementById('signalGrid');
            
            btn.innerHTML = '<span class="loading"></span> Analyzing...';
            btn.disabled = true;
            
            try {
                const formData = new FormData();
                formData.append('action', 'analyze');
                formData.append('csrf_token', '<?php echo generateCSRFToken(); ?>');
                formData.append('market', document.getElementById('marketSelect').value);
                formData.append('timeframe', document.getElementById('timeframeSelect').value);
                
                const response = await fetch('', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                // Update dashboard metrics
                document.getElementById('marketTrend').textContent = data.trend.toUpperCase();
                document.getElementById('volatilityStatus').textContent = (data.volatility * 100).toFixed(0) + '%';
                document.getElementById('signalConfidence').textContent = (data.confidence * 100).toFixed(0) + '%';
                
                // Populate signals
                grid.innerHTML = `
                    <div class="signal-item">
                        <div class="signal-label">RSI (14)</div>
                        <div class="signal-value">${data.signals.rsi}</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-label">MACD Signal</div>
                        <div class="signal-value">${data.signals.macd.toUpperCase()}</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-label">Bollinger Position</div>
                        <div class="signal-value">${(data.signals.bb_position * 100).toFixed(1)}%</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-label">Trend Strength</div>
                        <div class="signal-value">${(data.confidence * 100).toFixed(0)}%</div>
                    </div>
                `;
                
                document.getElementById('analysisTime').textContent = data.timestamp;
                result.classList.add('active');
                
            } catch (error) {
                console.error('Analysis failed:', error);
            } finally {
                btn.innerHTML = 'Run Analysis';
                btn.disabled = false;
            }
        }
        
        async function runAdvancedAnalysis() {
            const btn = document.getElementById('advAnalyzeBtn');
            const result = document.getElementById('advAnalysisResult');
            
            btn.innerHTML = '<span class="loading"></span> Processing...';
            btn.disabled = true;
            
            try {
                const formData = new FormData();
                formData.append('action', 'analyze');
                formData.append('csrf_token', '<?php echo generateCSRFToken(); ?>');
                formData.append('market', document.getElementById('advMarketSelect').value);
                formData.append('timeframe', document.getElementById('advTimeframeSelect').value);
                
                const response = await fetch('', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                document.getElementById('advTrend').textContent = data.trend.toUpperCase();
                document.getElementById('advStrength').textContent = (data.confidence * 100).toFixed(0) + '%';
                document.getElementById('advVolatility').textContent = data.volatility > 0.5 ? 'High' : 'Low';
                
                document.getElementById('advSignalGrid').innerHTML = `
                    <div class="signal-item">
                        <div class="signal-label">RSI (14)</div>
                        <div class="signal-value">${data.signals.rsi}</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-label">MACD Signal</div>
                        <div class="signal-value">${data.signals.macd.toUpperCase()}</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-label">Bollinger Position</div>
                        <div class="signal-value">${(data.signals.bb_position * 100).toFixed(1)}%</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-label">Volatility Index</div>
                        <div class="signal-value">${(data.volatility * 100).toFixed(1)}%</div>
                    </div>
                `;
                
                const summaries = {
                    bullish: `Market shows bullish momentum with ${(data.confidence * 100).toFixed(0)}% confidence. RSI at ${data.signals.rsi} suggests ${data.signals.rsi > 70 ? 'overbought conditions' : data.signals.rsi < 30 ? 'oversold conditions' : 'neutral momentum'}. MACD indicates ${data.signals.macd} trend continuation.`,
                    bearish: `Bearish pressure detected with ${(data.confidence * 100).toFixed(0)}% confidence. Current RSI reading of ${data.signals.rsi} indicates ${data.signals.rsi > 70 ? 'potential reversal zone' : data.signals.rsi < 30 ? 'selling exhaustion' : 'bearish consolidation'}.`,
                    neutral: `Market is in consolidation phase with mixed signals. RSI neutral at ${data.signals.rsi}. Recommend waiting for clearer directional bias before positioning.`
                };
                
                document.getElementById('marketSummary').textContent = summaries[data.trend] || summaries.neutral;
                
                result.style.display = 'block';
                result.classList.add('active');
                
            } catch (error) {
                console.error('Advanced analysis failed:', error);
            } finally {
                btn.innerHTML = 'Generate Report';
                btn.disabled = false;
            }
        }
        
        // Deriv WebSocket Connection (Foundation for real-time data)
        let derivWS = null;
        
        function connectDerivWebSocket() {
            // This is a placeholder for future Deriv WebSocket implementation
            // Actual implementation would use the encrypted token from database
            console.log('Deriv WebSocket connection ready for implementation');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            connectDerivWebSocket();
        });
    </script>
    
    <?php endif; ?>
    
</body>
</html>